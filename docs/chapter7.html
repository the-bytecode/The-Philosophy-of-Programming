<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 7: Immutable Core Identity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Source+Sans+3:wght@300;400;600&family=Source+Serif+4:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Source Sans 3', sans-serif;
            color: #333;
            line-height: 1.6;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Playfair Display', serif;
        }
        .content p, .content ul, .content ol {
            font-family: 'Source Serif 4', serif;
            font-size: 1.125rem;
            margin-bottom: 1.5rem;
        }
        .content h2 {
            margin-top: 2.5rem;
            margin-bottom: 1.5rem;
        }
        .content h3 {
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        .content ul, .content ol {
            margin-left: 1.5rem;
        }
        .content ul {
            list-style-type: disc;
        }
        .content ol {
            list-style-type: decimal;
        }
        .content li {
            margin-bottom: 0.5rem;
        }
        blockquote {
            font-style: italic;
            border-left: 4px solid #8B5CF6;
            padding-left: 1.5rem;
            margin: 2rem 0;
        }
        .chapter-nav a {
            transition: all 0.3s ease;
        }
        .chapter-nav a:hover {
            transform: translateY(-2px);
        }
        .gradient-text {
            background: linear-gradient(45deg, #3B82F6, #8B5CF6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        pre {
            font-family: 'JetBrains Mono', monospace;
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.5rem;
            overflow-x: auto;
            margin-bottom: 1.5rem;
            border: 1px solid #e2e8f0;
        }
        code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            background-color: #f1f5f9;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
        }
        pre code {
            background-color: transparent;
            padding: 0;
            font-size: 0.85rem;
            color: #1e293b;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-md py-4 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center">
                <a href="index.html" class="text-xl font-bold text-gray-800 hover:text-indigo-600 transition duration-300">
                    <i class="fas fa-book-open mr-2"></i>Philosophy of Programming
                </a>
                <div class="flex space-x-4">
                    <a href="index.html" class="text-gray-600 hover:text-indigo-600 transition duration-300">
                        <i class="fas fa-home"></i> <span class="hidden md:inline ml-1">Home</span>
                    </a>
                    <a href="chapter8.html" class="text-gray-600 hover:text-indigo-600 transition duration-300">
                        <i class="fas fa-arrow-right"></i> <span class="hidden md:inline ml-1">Next Chapter</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Chapter Header -->
    <header class="bg-gradient-to-r from-blue-50 to-indigo-50 py-20 px-4">
        <div class="max-w-4xl mx-auto text-center">
            <p class="text-indigo-600 font-semibold mb-2">Chapter 7</p>
            <h1 class="text-4xl md:text-5xl font-bold mb-6">Immutable Core Identity</h1>
            <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                Identify and protect the aspects of an entity that define its fundamental identity to create more robust and conceptually sound models.
            </p>
        </div>
    </header>

    <!-- Chapter Navigation -->
    <div class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between py-4 chapter-nav">
                <span class="text-gray-400">
                    <i class="fas fa-book mr-2"></i>Part II: Core Philosophical Principles
                </span>
                <div class="flex space-x-4">
                    <a href="chapter6.html" class="text-gray-600 hover:text-indigo-600 flex items-center">
                        <i class="fas fa-arrow-left mr-1"></i> Previous: Semantic Type Selection
                    </a>
                    <a href="chapter8.html" class="text-indigo-600 hover:text-indigo-800 flex items-center">
                        Next: Domain-Driven Flexibility <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Chapter Content -->
    <main class="bg-white py-12">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 content">
            <h2 class="text-2xl font-bold" id="identity-change">7.1 The Philosophy of Identity and Change</h2>
            <p>
                In both philosophy and programming, identity is a profound concept. What makes an entity what it is? What aspects can change while the entity remains fundamentally the same?
            </p>
            <p>
                Consider your own identity as a person. Your name is central to who you are—if someone tried to "update" your name to something else, they wouldn't be changing a property of you; they would be attempting to make you a different person. Similarly, your date of birth is immutable—it's a historical fact that cannot be changed without creating a fictional alternate reality.
            </p>
            <p>
                In contrast, your address, job title, or haircut can change without altering your fundamental identity. You remain the same person even as these attributes evolve.
            </p>
            <p>
                This philosophical understanding of identity and change should guide how we model entities in our code:
            </p>
            <pre><code>public final class Person {
    private final String firstName; // Immutable - defines identity
    private final String lastName; // Immutable - defines identity
    private final LocalDate dateOfBirth; // Immutable - historical fact
    private ContactInformation contactInfo; // Mutable - changes over time
    private EmploymentStatus employment; // Mutable - changes over time
    
    // Constructor with validation for identity attributes
    
    // No setters for identity attributes
    
    // Controlled methods to update non-identity attributes
    public void updateContactInformation(ContactInformation newContactInfo) {
        this.contactInfo = Objects.requireNonNull(newContactInfo);
    }
}</code></pre>
            <p>
                In this model, attributes that define the person's core identity (name, birth date) are immutable, while attributes that can change over time (contact information, employment) have controlled update methods.
            </p>

            <h2 class="text-2xl font-bold" id="core-attributes">7.2 Identifying Core Identity Attributes</h2>
            <p>
                How do we determine which attributes constitute an entity's core identity? Consider these guiding questions:
            </p>
            <ol>
                <li><strong>Replacement Test</strong>: If this attribute changed, would we consider it a different entity?</li>
                <li><strong>Historical Fact Test</strong>: Is this attribute a historical fact that cannot be changed without altering reality?</li>
                <li><strong>Reference Test</strong>: Do other entities refer to this entity based on this attribute?</li>
            </ol>
            <p>
                Let's apply these tests to a Movie entity:
            </p>
            <pre><code>public final class Movie {
    private final String title; // Core identity - passes replacement test
    private final LocalDate releaseDate; // Core identity - historical fact
    private final Set&lt;Person&gt; directors; // Core identity - key creative force
    private String synopsis; // Not core identity - can be revised
    private Rating criticRating; // Not core identity - subjective assessment
    
    // Constructor with validation for identity attributes
    
    // No setters for identity attributes
    
    // Controlled methods for non-identity attributes
    public void updateSynopsis(String newSynopsis) {
        this.synopsis = Objects.requireNonNull(newSynopsis);
    }
}</code></pre>
            <p>
                A movie's title, release date, and directors define its fundamental identity—changing any of these would make it a different movie. In contrast, its synopsis or critical rating can evolve without changing what movie it is.
            </p>
            <p>
                In the real world, consider how we identify movies: "Titanic (1997)" uses both title and release date because there have been multiple movies named "Titanic." The identity needs both attributes to be unique and definitive.
            </p>

            <h2 class="text-2xl font-bold" id="immutability-strategies">7.3 Immutability Implementation Strategies</h2>
            <p>
                Once we've identified core identity attributes, we need to make them truly immutable. Java provides several mechanisms for this:
            </p>
            <p>
                <strong>1. Final Fields</strong>: The most basic form of immutability
            </p>
            <pre><code>private final String title;</code></pre>
            <p>
                <strong>2. Immutable Collections</strong>: For collection attributes that define identity
            </p>
            <pre><code>private final Set&lt;Person&gt; directors;

public Movie(String title, LocalDate releaseDate, Set&lt;Person&gt; directors) {
    this.title = title;
    this.releaseDate = releaseDate;
    // Create immutable copy of the collection
    this.directors = Collections.unmodifiableSet(new HashSet<>(directors));
}</code></pre>
            <p>
                <strong>3. Defensive Copying</strong>: For returning collections without exposing internals
            </p>
            <pre><code>public Set&lt;Person&gt; getDirectors() {
    // Return a copy to prevent modification of the internal collection
    return new HashSet<>(directors);
}</code></pre>
            <p>
                <strong>4. Deep Immutability</strong>: Ensuring contained objects are also immutable
            </p>
            <pre><code>public final class Address {
    private final String street;
    private final String city;
    private final String postalCode;
    private final Country country;
    
    // Constructor with validation
    
    // No setters - completely immutable
}</code></pre>
            <p>
                These strategies ensure that once an entity is created, its core identity cannot be altered, maintaining the integrity of the domain model.
            </p>

            <h2 class="text-2xl font-bold" id="identity-equality">7.4 Identity vs. Equality</h2>
            <p>
                Immutable core identity has profound implications for how we implement equality in our classes. Two entities with identical attribute values might or might not be considered the same entity, depending on whether we're modeling an entity or a value object.
            </p>
            <p>
                For entities with intrinsic identity:
            </p>
            <pre><code>public class User {
    private final UUID id; // Intrinsic identity
    private String username; // Can change without affecting identity
    
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        User user = (User) o;
        return id.equals(user.id); // Equality based only on identity
    }
    
    @Override
    public int hashCode() {
        return Objects.hash(id);
    }
}</code></pre>
            <p>
                For value objects with no separate identity:
            </p>
            <pre><code>public final class Money {
    private final BigDecimal amount;
    private final Currency currency;
    
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Money money = (Money) o;
        return amount.equals(money.amount) && 
               currency.equals(money.currency); // Equality based on all attributes
    }
    
    @Override
    public int hashCode() {
        return Objects.hash(amount, currency);
    }
}</code></pre>
            <p>
                This distinction reflects a deep philosophical understanding of identity versus equality. In the real world, two $10 bills are considered equivalent (value equality), but two people with the same name are still distinct individuals (entity identity).
            </p>

            <h2 class="text-2xl font-bold" id="time-identity">7.5 Immutability and Time</h2>
            <p>
                Modeling time and change while maintaining immutable core identity presents interesting challenges. How do we represent an entity that evolves over time without changing its identity?
            </p>
            <p>
                The Event Sourcing pattern offers one solution:
            </p>
            <pre><code>public final class CustomerEvent {
    private final UUID customerId; // Link to the entity's identity
    private final LocalDateTime timestamp;
    private final CustomerEventType type;
    private final Map&lt;String, Object&gt; data;
    
    // Constructor with validation
    
    // Completely immutable - no setters
}

public class CustomerEventStream {
    private final UUID customerId;
    private final List&lt;CustomerEvent&gt; events = new ArrayList&lt;&gt;();
    
    public void addEvent(CustomerEventType type, Map&lt;String, Object&gt; data) {
        events.add(new CustomerEvent(customerId, LocalDateTime.now(), type, data));
    }
    
    public Customer reconstructCurrentState() {
        Customer customer = null;
        
        for (CustomerEvent event : events) {
            if (event.getType() == CustomerEventType.CREATED) {
                customer = createFromEvent(event);
            } else if (customer != null) {
                customer = applyEvent(customer, event);
            }
        }
        
        return customer;
    }
    
    // Helper methods to create and apply events
}</code></pre>
            <p>
                In this approach, the entity's state is reconstructed from an immutable stream of events. The entity's identity remains constant while its state evolves through additions to its event history.
            </p>
            <p>
                This mirrors how we think about people and their lives—a person's identity remains constant while their life story accumulates experiences and changes.
            </p>

            <h2 class="text-2xl font-bold" id="immutability-benefits">7.6 Benefits of Immutable Core Identity</h2>
            <p>
                Implementing immutable core identity yields numerous benefits:
            </p>
            <ol>
                <li><strong>Conceptual Clarity</strong>: The code clearly distinguishes between what defines an entity and what are merely changeable attributes.</li>
                <li><strong>Thread Safety</strong>: Immutable objects are inherently thread-safe, eliminating a whole class of concurrency bugs.</li>
                <li><strong>Defensive Programming</strong>: Immutability prevents unexpected state changes, making the system more predictable and robust.</li>
                <li><strong>Caching and Performance</strong>: Immutable objects can be freely shared and cached without fear of side effects.</li>
                <li><strong>Simplified Debugging</strong>: When an object's core identity cannot change, it's easier to track and debug issues.</li>
            </ol>
            <p>
                Immutable core identity is not just a technical practice but a philosophical approach that recognizes the profound distinction between what makes something what it is and what aspects of it can change over time.
            </p>

            <div class="mt-12 pt-6 border-t border-gray-200">
                <blockquote class="italic text-gray-600">
                    "The essence of an entity lies in its immutable core identity—those aspects that, if changed, would make it a fundamentally different entity."
                </blockquote>
            </div>

            <!-- Chapter Navigation (Bottom) -->
            <div class="mt-12 pt-6 border-t border-gray-200 flex justify-between chapter-nav">
                <a href="chapter6.html" class="text-indigo-600 hover:text-indigo-800 flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i> Previous: Semantic Type Selection
                </a>
                <a href="chapter8.html" class="text-indigo-600 hover:text-indigo-800 flex items-center">
                    Next: Domain-Driven Flexibility <i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>
        </div>
    </main>

    <!-- Related Chapters -->
    <section class="py-12 bg-gray-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold text-center mb-10">Continue Your Journey</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <a href="chapter6.html" class="bg-white rounded-xl shadow-md hover:shadow-xl p-6 border border-gray-100 transition duration-300 transform hover:-translate-y-1">
                    <div class="flex items-center mb-4">
                        <span class="text-indigo-600 text-lg font-semibold mr-2">Chapter 6:</span>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Semantic Type Selection</h3>
                    <p class="text-gray-600">Choose types based on their semantic meaning rather than technical convenience to create more expressive code.</p>
                </a>
                
                <a href="chapter8.html" class="bg-white rounded-xl shadow-md hover:shadow-xl p-6 border border-gray-100 transition duration-300 transform hover:-translate-y-1">
                    <div class="flex items-center mb-4">
                        <span class="text-indigo-600 text-lg font-semibold mr-2">Chapter 8:</span>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Domain-Driven Flexibility</h3>
                    <p class="text-gray-600">Balance rigidity and flexibility to create systems that can adapt to evolving requirements while maintaining conceptual integrity.</p>
                </a>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-2xl font-bold mb-4">The Philosophy of Programming</h3>
                    <p class="text-gray-300 mb-4">
                        A profound approach to software development that treats programming as a philosophical discipline.
                    </p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Chapter Navigation</h3>
                    <ul class="space-y-2">
                        <li><a href="#identity-change" class="text-gray-300 hover:text-white transition">7.1 The Philosophy of Identity and Change</a></li>
                        <li><a href="#core-attributes" class="text-gray-300 hover:text-white transition">7.2 Identifying Core Identity Attributes</a></li>
                        <li><a href="#immutability-strategies" class="text-gray-300 hover:text-white transition">7.3 Immutability Implementation Strategies</a></li>
                        <li><a href="#identity-equality" class="text-gray-300 hover:text-white transition">7.4 Identity vs. Equality</a></li>
                        <li><a href="#time-identity" class="text-gray-300 hover:text-white transition">7.5 Immutability and Time</a></li>
                        <li><a href="#immutability-benefits" class="text-gray-300 hover:text-white transition">7.6 Benefits of Immutable Core Identity</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Navigate</h3>
                    <ul class="space-y-2">
                        <li><a href="index.html" class="text-gray-300 hover:text-white transition">Table of Contents</a></li>
                        <li><a href="chapter6.html" class="text-gray-300 hover:text-white transition">Previous Chapter</a></li>
                        <li><a href="chapter8.html" class="text-gray-300 hover:text-white transition">Next Chapter</a></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
                <p>&copy; 2023 The Philosophy of Programming. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>